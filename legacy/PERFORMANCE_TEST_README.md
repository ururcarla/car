# ROI处理性能对比测试说明

## 测试目的

对比两种ROI处理方法的性能：
1. **画布处理方法**: 将所有ROI打包到一个大画布中进行推理
2. **批量处理方法**: 将ROI调整到统一大小后进行批量推理

## 测试脚本

### 1. 简单测试 (`simple_perf_test.py`)
**推荐使用** - 最简单的测试方式

```bash
python simple_perf_test.py
```

特点：
- 快速测试（3次运行）
- 直接对比两种方法
- 自动处理错误和异常

### 2. 快速测试 (`quick_performance_test.py`)
中等复杂度的测试

```bash
python quick_performance_test.py
```

特点：
- 测试不同ROI数量（4, 8, 12, 16）
- 详细的性能分析
- 内存使用分析
- 使用建议

### 3. 完整测试 (`performance_test.py`)
最详细的测试

```bash
python performance_test.py
```

特点：
- 最全面的性能分析
- 分阶段时间统计
- 详细的统计报告
- 可能需要较长时间

## 测试指标

### 时间指标
- **总处理时间**: 从ROI提取到结果映射的完整时间
- **ROI处理时间**: ROI提取和预处理时间
- **推理时间**: 模型推理时间
- **结果映射时间**: 将结果映射回原始坐标的时间

### 内存指标
- **画布处理内存**: 固定大小的画布内存使用
- **批量处理内存**: 根据ROI数量变化的批量内存使用

### 稳定性指标
- **标准差**: 多次运行的时间稳定性
- **成功率**: 成功完成的比例

## 预期结果

### 画布处理方法
**优势**:
- 内存使用固定且较小
- 处理稳定，错误率低
- 适合少量ROI

**劣势**:
- 画布打包有额外开销
- ROI在画布中可能变小，影响检测精度

### 批量处理方法
**优势**:
- 每个ROI保持原始分辨率
- 理论上GPU利用率更高
- 适合大量ROI

**劣势**:
- 内存使用随ROI数量增长
- 可能遇到OpenCV错误
- 需要严格的ROI验证

## 测试结果解读

### 性能提升倍数
- **> 1.2x**: 批量处理明显更快
- **0.8x - 1.2x**: 两种方法性能相近
- **< 0.8x**: 画布处理更快

### 内存使用
- **画布固定**: CANVAS_W × CANVAS_H × 3 bytes
- **批量变化**: ROI数量 × ROI_BATCH_SIZE² × 3 bytes

## 使用建议

### 选择画布处理的情况
- ROI数量较少（< 8个）
- 内存有限
- 稳定性优先
- 当前批量处理有问题的环境

### 选择批量处理的情况
- ROI数量较多（> 12个）
- 内存充足
- 追求最高性能
- 批量处理稳定的环境

### 配置建议
```python
# 稳定配置（推荐）
USE_BATCH_PROCESSING = False
USE_BEV_FUSION = True
FALLBACK_TO_CANVAS = True

# 性能优先配置（谨慎使用）
USE_BATCH_PROCESSING = True
USE_BEV_FUSION = True
FALLBACK_TO_CANVAS = True
```

## 故障排除

### 批量处理失败
如果批量处理失败，系统会自动回退到画布处理（如果启用了回退机制）。

### 测试失败
1. 检查依赖库是否正确安装
2. 确保有足够的GPU内存
3. 检查ROI数量是否合理

### 性能异常
1. 检查GPU使用情况
2. 确认没有其他程序占用资源
3. 多次运行取平均值

## 注意事项

1. **测试环境**: 确保测试环境与实际使用环境一致
2. **GPU状态**: 测试前确保GPU处于空闲状态
3. **多次运行**: 建议多次运行取平均值
4. **内存监控**: 注意监控内存使用情况
5. **错误处理**: 测试过程中可能遇到错误，这是正常的

## 扩展测试

如果需要测试特定场景，可以修改测试脚本：

```python
# 修改ROI数量
roi_counts = [2, 4, 6, 8, 10, 12, 16, 20]

# 修改测试运行次数
num_runs = 10  # 增加运行次数获得更准确的结果

# 修改ROI大小范围
w = np.random.randint(50, 200)  # 调整宽度范围
h = np.random.randint(50, 200)  # 调整高度范围
```

这些测试将帮助您找到最适合您具体使用场景的ROI处理方法。
